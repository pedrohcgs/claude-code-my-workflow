#!/bin/bash
# One-time setup: configure Dropbox and/or Overleaf sync for this project
#
# Usage: bash templates/setup-sync.sh
#
# What this does:
#   1. Asks for your sync targets (main Dropbox, Overleaf Dropbox, or both)
#   2. Writes .sync-config at repo root (gitignored, contains local paths)
#   3. Installs the post-commit hook (auto-pushes on every commit)
#   4. Creates sync-from-dropbox.sh at repo root (manually pull collaborator changes)

set -e

REPO_PATH="$(pwd)"

if [[ ! -f "$REPO_PATH/CLAUDE.md" ]]; then
    echo "Error: run this from the repo root (where CLAUDE.md lives)."
    exit 1
fi

echo "=== Sync setup ==="
echo ""

# --- Main Dropbox ---
read -rp "Do you sync project/ with a main Dropbox folder? (y/n): " USE_DROPBOX

DROPBOX_PATH=""
if [[ "$USE_DROPBOX" == "y" || "$USE_DROPBOX" == "Y" ]]; then
    read -rp "Dropbox path (e.g., C:/Users/you/Dropbox/shared-project): " DROPBOX_PATH
    if [[ -z "$DROPBOX_PATH" ]]; then
        echo "Error: Dropbox path is required."
        exit 1
    fi
fi

# --- Overleaf Dropbox ---
read -rp "Do you push outputs to an Overleaf Dropbox folder? (y/n): " USE_OVERLEAF

OVERLEAF_PATH=""
OVERLEAF_MAPPINGS=""
if [[ "$USE_OVERLEAF" == "y" || "$USE_OVERLEAF" == "Y" ]]; then
    read -rp "Overleaf Dropbox path (e.g., C:/Users/you/Dropbox/Apps/Overleaf/my-paper): " OVERLEAF_PATH
    if [[ -z "$OVERLEAF_PATH" ]]; then
        echo "Error: Overleaf path is required."
        exit 1
    fi

    echo ""
    echo "Which project subdirectories should sync to Overleaf?"
    echo "Enter mappings as source:dest pairs, one per line."
    echo "  source = path relative to repo root"
    echo "  dest   = path relative to Overleaf Dropbox root"
    echo ""
    echo "Example:"
    echo "  project/output/tables:tables"
    echo "  project/output/figures:figures"
    echo ""
    echo "Enter mappings (empty line to finish):"

    OVERLEAF_MAPPINGS=""
    while true; do
        read -rp "  " mapping
        if [[ -z "$mapping" ]]; then
            break
        fi
        if [[ "$mapping" != *":"* ]]; then
            echo "  Invalid format. Use source:dest (e.g., project/output/tables:tables)"
            continue
        fi
        if [[ -n "$OVERLEAF_MAPPINGS" ]]; then
            OVERLEAF_MAPPINGS="$OVERLEAF_MAPPINGS,$mapping"
        else
            OVERLEAF_MAPPINGS="$mapping"
        fi
    done

    if [[ -z "$OVERLEAF_MAPPINGS" ]]; then
        echo "Error: at least one mapping is required for Overleaf sync."
        exit 1
    fi
fi

if [[ -z "$DROPBOX_PATH" && -z "$OVERLEAF_PATH" ]]; then
    echo "No sync targets configured. Nothing to do."
    exit 0
fi

# --- Write .sync-config ---
echo ""
echo "Writing .sync-config..."
cat > "$REPO_PATH/.sync-config" <<CONF
# Sync configuration (generated by templates/setup-sync.sh)
# This file is gitignored---it contains machine-specific paths.

REPO_PATH=$REPO_PATH
DROPBOX_PATH=$DROPBOX_PATH
OVERLEAF_PATH=$OVERLEAF_PATH
OVERLEAF_MAPPINGS=$OVERLEAF_MAPPINGS
CONF
echo "  Created .sync-config"

# --- Install post-commit hook ---
echo "Installing post-commit hook..."
HOOK_FILE="$REPO_PATH/.git/hooks/post-commit"

if [[ -f "$HOOK_FILE" ]]; then
    echo "  Warning: $HOOK_FILE already exists. Backing up to post-commit.bak"
    cp "$HOOK_FILE" "$HOOK_FILE.bak"
fi

cat > "$HOOK_FILE" <<'HOOK'
#!/bin/bash
# Post-commit hook: sync to Dropbox and/or Overleaf
# Generated by templates/setup-sync.sh

REPO_ROOT="$(git rev-parse --show-toplevel)"
CONFIG="$REPO_ROOT/.sync-config"

if [[ ! -f "$CONFIG" ]]; then
    echo "post-commit: no .sync-config found. Run bash templates/setup-sync.sh"
    exit 0
fi

source "$CONFIG"

# --- Main Dropbox sync ---
if [[ -n "$DROPBOX_PATH" ]]; then
    echo "Syncing project/ to Dropbox..."
    rsync -av --delete \
        --exclude-from="$REPO_PATH/.syncignore" \
        "$REPO_PATH/project/" \
        "$DROPBOX_PATH/"
    echo "Dropbox sync complete."
fi

# --- Overleaf sync ---
if [[ -n "$OVERLEAF_PATH" && -n "$OVERLEAF_MAPPINGS" ]]; then
    echo "Syncing outputs to Overleaf..."
    IFS=',' read -ra PAIRS <<< "$OVERLEAF_MAPPINGS"
    for pair in "${PAIRS[@]}"; do
        src="${pair%%:*}"
        dest="${pair##*:}"
        if [[ -d "$REPO_PATH/$src" ]]; then
            mkdir -p "$OVERLEAF_PATH/$dest"
            rsync -av --delete \
                "$REPO_PATH/$src/" \
                "$OVERLEAF_PATH/$dest/"
            echo "  $src -> $dest"
        fi
    done
    echo "Overleaf sync complete."
fi
HOOK
chmod +x "$HOOK_FILE"
echo "  Created $HOOK_FILE"

# --- Create sync-from-dropbox.sh ---
if [[ -n "$DROPBOX_PATH" ]]; then
    echo "Creating sync-from-dropbox.sh..."
    cat > "$REPO_PATH/sync-from-dropbox.sh" <<PULL
#!/bin/bash
# Pull updates from Dropbox into project/
# Run manually at the start of each session

source "\$(dirname "\$0")/.sync-config"

if [[ -z "\$DROPBOX_PATH" ]]; then
    echo "No Dropbox path configured in .sync-config"
    exit 1
fi

echo "Pulling from Dropbox into project/..."
rsync -av \\
    --exclude-from="\$REPO_PATH/.syncignore" \\
    "\$DROPBOX_PATH/" \\
    "\$REPO_PATH/project/"

echo "Sync complete. Checking git status..."
cd "\$REPO_PATH" && git status --short
PULL
    chmod +x "$REPO_PATH/sync-from-dropbox.sh"
    echo "  Created sync-from-dropbox.sh"
fi

echo ""
echo "=== Setup complete ==="
echo ""
if [[ -n "$DROPBOX_PATH" ]]; then
    echo "Main Dropbox:  $DROPBOX_PATH"
    echo "  - Every commit pushes project/ to Dropbox (with --delete)"
    echo "  - Run 'bash sync-from-dropbox.sh' to pull collaborator changes"
fi
if [[ -n "$OVERLEAF_PATH" ]]; then
    echo "Overleaf:      $OVERLEAF_PATH"
    echo "  - Every commit pushes configured output directories to Overleaf"
    echo "  Mappings:"
    IFS=',' read -ra PAIRS <<< "$OVERLEAF_MAPPINGS"
    for pair in "${PAIRS[@]}"; do
        echo "    ${pair%%:*} -> ${pair##*:}"
    done
fi
echo ""
echo "Config saved to .sync-config (gitignored)."
